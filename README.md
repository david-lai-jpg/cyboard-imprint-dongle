# Cyboard Imprint Dongle Firmware

Personal [ZMK](https://zmk.dev/) firmware for the [Cyboard Imprint](https://cyboard.digital/) split keyboard with a **USB dongle central**. Features home row mods, tap-dance, mod-morphs, dual trackball support, and RGB underglow.

## Architecture

```
                          BLE
[Left Half] <------------------------------> [Dongle] <---- USB ----> [PC]
 assimilator-bt                               nRF52840
 PMW3610 trackball (scroll)                   SH1106 OLED
 WS2812 RGB underglow                        Mock kscan (no keys)

                          BLE
[Right Half] <-----------------------------> [Dongle]
 assimilator-bt
 PMW3610 trackball (cursor)
 WS2812 RGB underglow
```

- **Dongle** (`nice_nano`): BLE central + USB HID. Receives key matrix + dual trackball data from both halves, outputs to host. Has an SH1106 128x64 OLED display.
- **Left half** (`assimilator-bt`): BLE peripheral. PMW3610 trackball configured as scroll wheel. WS2812 RGB underglow (150 LEDs).
- **Right half** (`assimilator-bt`): BLE peripheral. PMW3610 trackball configured as mouse cursor. WS2812 RGB underglow (150 LEDs).

### Dual Trackball Forwarding

Each half forwards its trackball data to the dongle over a dedicated BLE `input-split` channel:

| Channel | Source | Dongle Listener | Function |
|---------|--------|-----------------|----------|
| 0 | Left PMW3610 | `trackball_central_listener` | Scroll (0.035x, Y-inverted) |
| 1 | Right PMW3610 | `trackball_peripheral_listener` | Mouse cursor (1.65x) |

## Key Positions

![Key Positions](KEY_POSITIONS.svg "82-key position reference")

## Keymap

Using the `imprint_function_row_full_bottom_row` matrix transform (82 keys).

![Keymap Diagram](keymap-drawer/imprint_dongle.svg "Generated by keymap-drawer")

## Layers

| Layer | Name | Activation | Description |
|-------|------|------------|-------------|
| 0 | BASE | Default | QWERTY with number row, home row mods (CTRL/ALT/GUI/SHIFT), tap-dance shift/caps lock, mouse buttons on upper right thumb |
| 1 | NUMBER | `num_lt` hold (right thumb) | Left-hand numpad (7-8-9 / 4-5-6 / 1-2-3), right-hand arrow navigation, bracket mod-morphs |
| 2 | FN | `mouse_lt_enter` hold (right thumb) | BT profile selection (5 slots + clear), function keys (F1-F13), RGB underglow toggle/effect, arrow navigation |
| 3 | MOUSELESS | `mouse_lt_enter` tap (right thumb) | Home row letter keys (ASDF/JKL;), macOS screenshot shortcuts, toggle exit |
| 4 | SYMBOLS | `fn_lt_enter` hold (right thumb) | Symbols (&*()$%^!@#), arrow navigation, bracket mod-morphs |

## Features

- **Home row mods** -- CTRL/ALT/GUI/SHIFT on ASDF (left) and JKL; (right) via balanced hold-tap with 280ms tapping term, positional hold-trigger, and require-prior-idle
- **Tap-dance** -- single-tap for Shift, double-tap for Caps Lock
- **Mod-morphs** -- `{` / `[` and `}` / `]` toggled by holding Shift
- **Layer macros** -- `fn_layer_color` and `sym_layer_color` for momentary layer activation, `mouse_tog_enter`/`mouse_tog_exit` for toggling the mouse layer
- **Bluetooth** -- 5 profile slots (BT_SEL 0-4), BT_CLR, and BT_CLR_ALL on the FN layer
- **Mouse buttons** -- left-click and right-click on upper right thumb cluster (pos 73-74)
- **RGB underglow** -- toggle and effect cycling on the FN layer, default color HSV(343, 69%, 50%)
- **Dual trackballs** -- left trackball for scrolling (0.035x sensitivity, Y-inverted), right trackball for cursor (1.65x sensitivity)
- **USB dongle central** with SH1106 OLED display

## Building

Firmware builds automatically via GitHub Actions on every push. Download artifacts from the [latest successful run](../../actions/workflows/build.yml).

### Build Matrix

| Artifact | Board | Shield | Description |
|----------|-------|--------|-------------|
| `imprint_dongle` | `nice_nano` | `imprint_dongle` | Dongle central (USB + OLED) |
| `imprint_dongle_left` | `assimilator-bt` | `imprint_dongle_left` | Left peripheral |
| `imprint_dongle_right` | `assimilator-bt` | `imprint_dongle_right` | Right peripheral |
| `settings_reset_dongle` | `nice_nano` | `settings_reset` | Bond clearing for dongle |
| `imprint_left` | `assimilator-bt` | `imprint_left` | Fallback: original non-dongle left |
| `imprint_right` | `assimilator-bt` | `imprint_right` | Fallback: original non-dongle right |

## Flashing

### Initial Setup (First Time)

1. **Clear bonds on dongle**: Flash `settings_reset_dongle.uf2` to the dongle via USB
2. **Flash dongle firmware**: Flash `imprint_dongle.uf2` to the dongle
3. **Clear bonds on halves**: On each half, use `&bt BT_CLR_ALL` from the FN layer (Layer 2), or flash the original `settings_reset` UF2 if available
4. **Flash left half**: Flash `imprint_dongle_left.uf2` via USB bootloader
5. **Flash right half**: Flash `imprint_dongle_right.uf2` via USB bootloader
6. **Pair**: Power cycle all three devices. They should auto-pair.

### Entering Bootloader

- **Dongle**: Double-tap the reset button
- **Keyboard halves**: Double-tap the reset button on the assimilator-bt PCB

### Troubleshooting Pairing

If halves don't connect to the dongle:

1. Flash `settings_reset_dongle.uf2` to the dongle
2. Use `&bt BT_CLR_ALL` on both halves (Layer 2 has BT controls)
3. Re-flash the dongle firmware
4. Power cycle all devices

## File Structure

```
boards/shields/imprint_dongle/
├── Kconfig.shield              # Shield symbol definitions (3 variants)
├── Kconfig.defconfig           # Feature flags, display config, RGB, trackball
├── imprint_dongle.dtsi         # Shared: 14 matrix transforms, kscan, dual input-splits
├── imprint_dongle.overlay      # Dongle: mock kscan, OLED display (SH1106 I2C)
├── imprint_dongle_left.overlay # Left: row GPIOs, PMW3610, input-split channel 0
├── imprint_dongle_right.overlay# Right: row GPIOs + offsets, PMW3610, input-split channel 1
└── boards/
    └── assimilator-bt.overlay  # SPI pinctrl for trackball + WS2812 LEDs

config/
├── imprint_dongle.conf         # Base conf (all 3 builds): TX power, RGB off, display on
├── imprint_dongle_left.conf    # Left: RGB on + color settings, display off
├── imprint_dongle_right.conf   # Right: RGB on + color settings, display off
├── imprint_dongle.keymap       # Keymap (shared by all 3 builds)
├── imprint_dongle.json         # Physical layout for keymap-drawer
└── west.yml                    # West manifest (ZMK + Cyboard module)

keymap-drawer/
├── imprint_dongle.svg          # Generated keymap visualization
└── imprint_dongle.yaml         # Parsed keymap (intermediate format)

keymap_drawer.config.yaml       # Keymap-drawer rendering config
KEY_POSITIONS.svg               # 82-key position reference diagram
```

## References

- [ZMK Dongle Documentation](https://zmk.dev/docs/development/hardware-integration/dongle)
- [Cyboard Imprint Docs](https://docs.cyboard.digital/)
- [ZMK Documentation](https://zmk.dev/docs)
- [ZMK Keycodes Reference](https://zmk.dev/docs/keymaps/list-of-keycodes)
- [keymap-drawer](https://github.com/caksoylar/keymap-drawer) (keymap visualization)
